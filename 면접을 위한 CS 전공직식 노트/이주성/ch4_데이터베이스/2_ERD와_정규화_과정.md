## ERD와 정규화 과정

**ERD(Entity Relationship Diagram)란?**

- 데이터베이스 구축 시 뼈대 역할
- 요구사항을 기반으로 릴레이션 간의 관계 정의

<br/>

---

### ERD의 중요성

- ERD를 기반으로 DB를 구축
- DB를 구축한 이후에도 재설계가 필요한 경우 설계도 역할

> 비정형 데이터를 충분히 표현할 수 없다는 단점이 있다.
> - 비정형 데이터: 비구조화 데이터로 미리 정의된 모델이 없거나 미리 정의된 방식으로 정리되지 않은 정보

<br/>

---

### 정규화 과정

- 데이터 평탄화 작업
- 릴레이션 간 잘못된 종속 관계로 인해 데이터베이스 이상 현상이 일어나서 이를 해결하는 과정
  - 이상 현상: 갱신, 삽입, 삭제 이상
- 저장 공간을 효율적으로 사용하기 위해 릴레이션을 여러 개로 분리하는 과정
- 정규형 원칙을 기반으로 정규형을 만들어가는 과정
  - 제 1~5 정규형, 보이스/코드 정규형

**정규형 원칙**

- 같은 의미를 표현하는 릴레이션이지만 좀 더 좋은 구조로 만들어야 한다.
- 자료의 중복성은 감소해야 한다.
- 독립적인 관계는 별개의 릴레이션으로 표현해야 한다.
- 각각의 릴레이션은 독립적인 표현이 가능해야 한다.


<br/>

---

### 1차 정규화 (1NF)

- 릴레이션의 모든 도메인이 더 이상 분해될 수 없는 원자 값(atomic value)만으로 구성되어야 한다.
- 자료형에 여러 개의 데이터를 담으면 안된다. (리스트 금지)


![img_9.png](img_9.png)

- 수강 과목 컬럼에 하나의 데이터만 있어야 하는데 ","로 구분된 리스트로 구성되어 있다.
- 1차 정규화 대상

![img_10.png](img_10.png)

<br/>

---

### 2차 정규화 (2NF)

- 부분 함수의 종속성을 제거한다.
- 기본키가 아닌 모든 속성이 기본키에 완전 함수 종속적인 경우

**2차 정규화 대상**

- 복합키에서 후보키에 종속되어 있는 경우 별도 테이블로 분리
  - 후보키는 레코드를 유일하게 구분해낼 수 있는 키 컬럼 그룹을 뜻한다.
  - 후보키가 2개 이상이면 복합키
- 종속성 관계에서 원인이 되는 컬럼이 후보키여야 한다.
  - 즉, PK 중 하나여야 한다.
- 정규화 후 두 테이블은 자연스럽게 식별 관계가 된다.
  - 외래키가 복합키로 참여하는 형태

![img_11.png](img_11.png)

- 이전의 1차 정규화 마친 테이블에 담당 교수와 성적 컬림이 추가된 상황
- 데이터를 유일하게 구분짓는 컬럼(후보키)
  - 학번만으로는 여러 과목을 들을 경우 유일하게 구분지을 수 없다.
  - 과목 하나당 교수님 하나라고 가정했을 때 담당 교수는 수강 과목에 종속적이고, 수강 과목은 후보키 중 하나이므로 2차 정규화의 대상이 된다. 
  - 이름도 마찬가지로 학번에 종속적이고 학번은 후보키 중 하나이므로 2차 정규화의 대상이다. 

**2차 정규화 시작**

- 수강 과목별 담당 교수를 새로운 테이블로 분리
- 학번별 이름, 즉 학생 정보도 새로운 테이블로 분리
- 학번과 수강과목은 식별관계가 되고 이를 통해 검색할 수 있다.

![img_12.png](img_12.png)

> 결론적으로 수강과목별 담당교수 정보와 학생 현황 정보는 N:N 관계였는데 중간에 테이블 하나를 통해 1:N 관계로 풀은 것이다.

> 테이블이 3개로 나눠졌지만 데이터를 사용하는 사용자에게는 정규화하기 전 상태의 테이블로 보여줘야 하기 때문에 JOIN을 사용해야 한다.


<br/>

---

### 3차 정규화(3NF)

- 기본키가 아닌 모든 속성이 이행적 함수 종속(transitive FD)를 만족하지 않는 상태
  - 이행적 함수 종속?
    - A -> B와 B -> C가 존재하면 논리적으로 A -> C가 만족하는데, 이 때 집합 C가 집합 A에 이행적으로 함수 종속 되었다고 한다.
- 3차 정규화 후 두 테이블은 비식별 관계가 된다.

![img_13.png](img_13.png)

- 단과대별 학습 성취도를 보고 싶어서 단과대와 학과 컬럼 추가한 상황
- 단과대는 학과에 속해있고, 학생은 학과에 속하게 되는 상황 → 2 depth 종속


**3차 정규화 진행**

1. 학과가 결정되면 단과대는 자연스럽게 결정되는 것이므로 테이블을 분리한다.

![img_14.png](img_14.png)

2. 학생 현황으로 join할 때 편의성을 위해 복합키를 '학과코드'라는 대체키 하나로 관리한다.

![img_16.png](img_16.png)

- 자연스럽게 비식별 관계로 연결되었다.



<br/>

---

### Boyce-Codd 정규화

- 결정자이면서 후보키가 아닌 것 제거한다. 즉, 모든 결정자가 후보키가 되어야 한다.
  - 함수 종속 관계에서 특정 종속자를 결정짓는 요소, 'X->Y'일 때 X가 결정자, Y는 종속자이다.
- 마스터코드 관리 테이블 정도로 표현되게 된다.
- ERD를 그릴 때 마스터코드는 릴레이션을 굳이 표시하지 않는다.


**정규화 대상**

![img_17.png](img_17.png)

- 성적에 대한 등급 컬럼이 추가된 상황
- 등급 컬럼은 성적 컬럼에 의존하지만 성적 컬럼은 후보키가 아니다. 따라서 정규화가 필요하다.

**보이스-코드 정규화 진행**

성적은 후보키가 아니기 때문에 섣불리 테이블을 분리하면 기준 데이터를 찾을 수 없게 된다. 따라서 기준 테이블을 별도로 만들어준다.

![img_18.png](img_18.png)

- 등급 기준표는 후보키가 아닌 성적 컬럼에서 분리했으므로 관계를 가지지 않는다.
- 관계가 없는데 어떻게 등급 기준표를 DDL로 참고하도록 할까? 코멘트를 달아줄 필요가 있다.
- 여러 기준을 만족하는 마스터 테이블을 구성하는 것은 설계자의 노하우이다.


**최종 테이블**

![img_19.png](img_19.png)


<br/>

---

### 역정규화

정규화를 진행하다보니 테이블이 너무 많이 분리돼서 조인하기 힘든 상황이 발생하면 역정규화가 필요하다. 

이름이 학생 현황 테이블로 빠졌지만 수강생 과목별 중간고사 메인 테이블에서 항상 학생 이름이 필요할 경우 조인 편의성을 위해 컬럼을 추가할 수 있다.
- 이 경우 수정한 컬럼을 수정하면 기존 학생 현황과의 데이터 무결성이 깨지기 때문에 수정을 막는 게 기본적이다. 

> 보통 학번-이름이나 코드-코드명 과 같은 관계는 역정규화를 해두는 편이다.





<br/>

---

**참고**

- https://inpa.tistory.com/entry/DB-📚-데이터-모델링-1N-관계-📈-ERD-다이어그램
- https://www.youtube.com/watch?v=68o6mQOewF8&list=PLeMeDIV7bypucXKDTJm5PKrHab8HKDhCK&index=7
- 